<?xml version="1.0" encoding="UTF-8"?>
<xwikidoc>
<web>Admin</web>
<name>CheckRights</name>
<language></language>
<defaultLanguage></defaultLanguage>
<translation>0</translation>
<parent>Admin.Tools</parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1374224639000</creationDate>
<date>1262300400000</date>
<contentUpdateDate>1262300400000</contentUpdateDate>
<version>1.1</version>
<title>Check Rights</title>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment>Imported from XAR</comment>
<minorEdit>false</minorEdit>
<syntaxId>xwiki/1.0</syntaxId>
<hidden>false</hidden>
<content>&lt;%
println "Add this specific user to the rights view: "

println "&lt;form action='' method='get'&gt;"
if (xwiki.isVirtual()) {
 def url = doc.getURL("view","xpage=uorgsuggest&amp;classname=XWiki.XWikiUsers&amp;wiki=global&amp;uorg=user&amp;")
 println "&lt;input type='text' name='user' autocomplete='off' value='' size='40' onfocus=\"new ajaxSuggest(this, { script: '${url}&amp;', varname:'input' })\" /&gt;"
} else {
def sql = ", BaseObject as obj, StringProperty as fprop, StringProperty as lprop where doc.fullName=obj.name and obj.className='XWiki.XWikiUsers' and obj.id=fprop.id.id and fprop.id.name='first_name' and lprop.id.id=obj.id and lprop.id.name='last_name' order by fprop.value, lprop.value"
println "&lt;select name='user'&gt;"
for (item in xwiki.searchDocuments(sql)) {
 def username = xwiki.getUserName(item, false)
 println "&lt;option value='${item}'&gt;${username}&lt;/option&gt;" 
}
 println "&lt;/select&gt;"
}

println "&lt;input type='submit' value='go'/&gt;&lt;/form&gt;"


def showUserLine(text, user, page) { return showLine(text,user,page,true) }
def showGroupLine(text, user, page) { return showLine(text,user,page,false) }
def showLine(text, user, page, isuser) {
rights = ["view", "comment", "edit", "admin"];
str = text;
for(right in rights) {
str += " | "
if (isuser) { str += xwiki.hasAccessLevel(right, user, page ) } else { str += xwiki.getXWiki().rightService.hasAccessLevel(right, user, page, false, context.context) }
}
return str
}

def showUserTable(page) {
str = "{table}\n"
str += "Group or User|VIEW|COMMENT|EDIT|ADMIN\n"
str += "\n"
if (xwiki.isVirtual()) {
 str += showGroupLine("*Members of Global All Group*", "xwiki:XWiki.XWikiAllGroup", page)
 str += "\n"
}
if (request.user) {
str += showUserLine("*User ${request.user}*", request.user, page)
str += "\n"
}
if (request.group) {
str += showGroupLine("*Group ${request.group}*", request.group, page)
str += "\n"
}
str += "{table}\n"
return str
}

def displayRights(page, classname) {
 def pagedoc = xwiki.getDocument(page)
 def str = "{table}\n"
 str += "Right|Allow|Users|Groups\n"
 for(obj in pagedoc.getObjects(classname)) {
   pagedoc.use(obj)
   def levels = pagedoc.levels
   def allow = pagedoc.allow
   def users = pagedoc.users
   def groups = pagedoc.groups
   str += " ${levels} | ${allow} | ${users} | ${groups} \n"
 }
 str += "{table}\n\n"
 return str
 }
%&gt;

1.1 All the wiki

&lt;%
println showUserTable("Toto.Tata")
%&gt;

1.1 Home Page

&lt;%
println showUserTable("Main.WebHome")
%&gt;

1.1 Spaces with specific rights

&lt;%
for(item in xwiki.searchDocuments(", BaseObject as obj where obj.name=doc.fullName and obj.className='XWiki.XWikiGlobalRights' and doc.name='WebPreferences'", 0, 0)) {
itemdoc = xwiki.getDocument(item)
println "1.1.1 Space ${itemdoc.web}"
println displayRights("${itemdoc.web}.WebPreferences", "XWiki.XWikiGlobalRights")
println showUserTable("${itemdoc.web}.Taratata")
}
%&gt;

1.1 Pages with specific rights

&lt;%
for(item in xwiki.searchDocuments(", BaseObject as obj where obj.name=doc.fullName and obj.className='XWiki.XWikiRights' and doc.web&lt;&gt;'XWiki' and doc.web&lt;&gt;'Questions'", 0, 0)) {
println "1.1.1 Page ${item}"
println displayRights(item, "XWiki.XWikiRights")
println showUserTable(item)
}
%&gt;
</content><versions>head	1.1;
access;
symbols;
locks; strict;
comment	@# @;


1.1
date	2010.01.01.00.00.00;	author XWiki_2EAdmin;	state full;
branches;
next	;


desc
@@


1.1
log
@Imported from XAR
@
text
@&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;xwikidoc&gt;
&lt;web&gt;Admin&lt;/web&gt;
&lt;name&gt;CheckRights&lt;/name&gt;
&lt;language&gt;&lt;/language&gt;
&lt;defaultLanguage&gt;&lt;/defaultLanguage&gt;
&lt;translation&gt;0&lt;/translation&gt;
&lt;parent&gt;Admin.Tools&lt;/parent&gt;
&lt;creator&gt;XWiki.Admin&lt;/creator&gt;
&lt;author&gt;XWiki.Admin&lt;/author&gt;
&lt;customClass&gt;&lt;/customClass&gt;
&lt;contentAuthor&gt;XWiki.Admin&lt;/contentAuthor&gt;
&lt;creationDate&gt;1374224639000&lt;/creationDate&gt;
&lt;date&gt;1262300400000&lt;/date&gt;
&lt;contentUpdateDate&gt;1262300400000&lt;/contentUpdateDate&gt;
&lt;version&gt;1.1&lt;/version&gt;
&lt;title&gt;Check Rights&lt;/title&gt;
&lt;defaultTemplate&gt;&lt;/defaultTemplate&gt;
&lt;validationScript&gt;&lt;/validationScript&gt;
&lt;comment&gt;Imported from XAR&lt;/comment&gt;
&lt;minorEdit&gt;false&lt;/minorEdit&gt;
&lt;syntaxId&gt;xwiki/1.0&lt;/syntaxId&gt;
&lt;hidden&gt;false&lt;/hidden&gt;
&lt;content&gt;&amp;lt;%
println "Add this specific user to the rights view: "

println "&amp;lt;form action='' method='get'&amp;gt;"
if (xwiki.isVirtual()) {
 def url = doc.getURL("view","xpage=uorgsuggest&amp;amp;classname=XWiki.XWikiUsers&amp;amp;wiki=global&amp;amp;uorg=user&amp;amp;")
 println "&amp;lt;input type='text' name='user' autocomplete='off' value='' size='40' onfocus=\"new ajaxSuggest(this, { script: '${url}&amp;amp;', varname:'input' })\" /&amp;gt;"
} else {
def sql = ", BaseObject as obj, StringProperty as fprop, StringProperty as lprop where doc.fullName=obj.name and obj.className='XWiki.XWikiUsers' and obj.id=fprop.id.id and fprop.id.name='first_name' and lprop.id.id=obj.id and lprop.id.name='last_name' order by fprop.value, lprop.value"
println "&amp;lt;select name='user'&amp;gt;"
for (item in xwiki.searchDocuments(sql)) {
 def username = xwiki.getUserName(item, false)
 println "&amp;lt;option value='${item}'&amp;gt;${username}&amp;lt;/option&amp;gt;" 
}
 println "&amp;lt;/select&amp;gt;"
}

println "&amp;lt;input type='submit' value='go'/&amp;gt;&amp;lt;/form&amp;gt;"


def showUserLine(text, user, page) { return showLine(text,user,page,true) }
def showGroupLine(text, user, page) { return showLine(text,user,page,false) }
def showLine(text, user, page, isuser) {
rights = ["view", "comment", "edit", "admin"];
str = text;
for(right in rights) {
str += " | "
if (isuser) { str += xwiki.hasAccessLevel(right, user, page ) } else { str += xwiki.getXWiki().rightService.hasAccessLevel(right, user, page, false, context.context) }
}
return str
}

def showUserTable(page) {
str = "{table}\n"
str += "Group or User|VIEW|COMMENT|EDIT|ADMIN\n"
str += "\n"
if (xwiki.isVirtual()) {
 str += showGroupLine("*Members of Global All Group*", "xwiki:XWiki.XWikiAllGroup", page)
 str += "\n"
}
if (request.user) {
str += showUserLine("*User ${request.user}*", request.user, page)
str += "\n"
}
if (request.group) {
str += showGroupLine("*Group ${request.group}*", request.group, page)
str += "\n"
}
str += "{table}\n"
return str
}

def displayRights(page, classname) {
 def pagedoc = xwiki.getDocument(page)
 def str = "{table}\n"
 str += "Right|Allow|Users|Groups\n"
 for(obj in pagedoc.getObjects(classname)) {
   pagedoc.use(obj)
   def levels = pagedoc.levels
   def allow = pagedoc.allow
   def users = pagedoc.users
   def groups = pagedoc.groups
   str += " ${levels} | ${allow} | ${users} | ${groups} \n"
 }
 str += "{table}\n\n"
 return str
 }
%&amp;gt;

1.1 All the wiki

&amp;lt;%
println showUserTable("Toto.Tata")
%&amp;gt;

1.1 Home Page

&amp;lt;%
println showUserTable("Main.WebHome")
%&amp;gt;

1.1 Spaces with specific rights

&amp;lt;%
for(item in xwiki.searchDocuments(", BaseObject as obj where obj.name=doc.fullName and obj.className='XWiki.XWikiGlobalRights' and doc.name='WebPreferences'", 0, 0)) {
itemdoc = xwiki.getDocument(item)
println "1.1.1 Space ${itemdoc.web}"
println displayRights("${itemdoc.web}.WebPreferences", "XWiki.XWikiGlobalRights")
println showUserTable("${itemdoc.web}.Taratata")
}
%&amp;gt;

1.1 Pages with specific rights

&amp;lt;%
for(item in xwiki.searchDocuments(", BaseObject as obj where obj.name=doc.fullName and obj.className='XWiki.XWikiRights' and doc.web&amp;lt;&amp;gt;'XWiki' and doc.web&amp;lt;&amp;gt;'Questions'", 0, 0)) {
println "1.1.1 Page ${item}"
println displayRights(item, "XWiki.XWikiRights")
println showUserTable(item)
}
%&amp;gt;
&lt;/content&gt;&lt;/xwikidoc&gt;@
</versions></xwikidoc>