<?xml version="1.0" encoding="UTF-8"?>
<xwikidoc>
<web>Admin</web>
<name>CheckProgrammingRights</name>
<language></language>
<defaultLanguage></defaultLanguage>
<translation>0</translation>
<parent>Admin.WebHome</parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1374224638000</creationDate>
<date>1353157611000</date>
<contentUpdateDate>1353157611000</contentUpdateDate>
<version>1.1</version>
<title>Check programming rights</title>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment>Imported from XAR</comment>
<minorEdit>false</minorEdit>
<syntaxId>xwiki/2.0</syntaxId>
<hidden>false</hidden>
<object>
<class>
<name>XWiki.JavaScriptExtension</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<cache>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>cache</name>
<number>5</number>
<prettyName>Caching policy</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>long|short|default|forbid</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</cache>
<code>
<disabled>0</disabled>
<name>code</name>
<number>2</number>
<prettyName>Code</prettyName>
<rows>20</rows>
<size>50</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
</code>
<name>
<disabled>0</disabled>
<name>name</name>
<number>1</number>
<prettyName>Name</prettyName>
<size>30</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.StringClass</classType>
</name>
<parse>
<disabled>0</disabled>
<displayFormType>select</displayFormType>
<displayType>yesno</displayType>
<name>parse</name>
<number>4</number>
<prettyName>Parse content</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</parse>
<use>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>use</name>
<number>3</number>
<prettyName>Use this extension</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>currentPage=Always on this page|onDemand=On demand|always=Always on this wiki</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</use>
</class>
<name>Admin.CheckProgrammingRights</name>
<number>0</number>
<className>XWiki.JavaScriptExtension</className>
<guid>18d70e37-7b7c-476b-911c-39a22da0e9bd</guid>
<property>
<cache>forbid</cache>
</property>
<property>
<code>document.observe("xwiki:dom:loaded", function() {

    var handleSelect = function(event, checked) {
        var fragments = event.findElement().identify().split(':');
        if (fragments.length == 2) {
            var wikiname = fragments[1];
            var id = 'pagelist:' + wikiname;
            var selector = '#' + id;

            $(id).select('input[name=pagelist]').each(function (input) {
                input.checked = checked;
            });
        } else {
            $$('input[name=pagelist]').each(function (input) {
                input.checked = checked;
            });
        }
    };

    $$('.unselect_all').each(function (element) {
        element.observe('click', function (event) {
            handleSelect(event, false);
        });
    });

    $$('.select_all').each(function (element) {
        element.observe('click', function (event) {
            handleSelect(event, true);
        });
    });
});</code>
</property>
<property>
<name>Checkbox control</name>
</property>
<property>
<parse>0</parse>
</property>
<property>
<use>currentPage</use>
</property>
</object>
<object>
<class>
<name>XWiki.RequiredRightClass</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<level>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>level</name>
<number>1</number>
<picker>0</picker>
<prettyName>level</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<sort>none</sort>
<unmodifiable>0</unmodifiable>
<validationMessage></validationMessage>
<validationRegExp></validationRegExp>
<values>edit|programming</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</level>
</class>
<name>Admin.CheckProgrammingRights</name>
<number>0</number>
<className>XWiki.RequiredRightClass</className>
<guid>2e93c625-8350-4ca0-8437-90153c3394d5</guid>
<property>
<level>programming</level>
</property>
</object>
<object>
<class>
<name>XWiki.StyleSheetExtension</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<cache>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>cache</name>
<number>5</number>
<prettyName>Caching policy</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>long|short|default|forbid</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</cache>
<code>
<disabled>0</disabled>
<name>code</name>
<number>2</number>
<prettyName>Code</prettyName>
<rows>20</rows>
<size>50</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
</code>
<name>
<disabled>0</disabled>
<name>name</name>
<number>1</number>
<prettyName>Name</prettyName>
<size>30</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.StringClass</classType>
</name>
<parse>
<disabled>0</disabled>
<displayFormType>select</displayFormType>
<displayType>yesno</displayType>
<name>parse</name>
<number>4</number>
<prettyName>Parse content</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</parse>
<use>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>use</name>
<number>3</number>
<prettyName>Use this extension</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>currentPage=Always on this page|onDemand=On demand|always=Always on this wiki</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</use>
</class>
<name>Admin.CheckProgrammingRights</name>
<number>0</number>
<className>XWiki.StyleSheetExtension</className>
<guid>01831ba2-9cb5-4583-9e14-7812fe173615</guid>
<property>
<cache>forbid</cache>
</property>
<property>
<code>legend.wikiname {
    font-size: larger;
    padding-top: 0.5em;
    padding-bottom: 0.5em;
}

div.select_checkbox_control {
    margin-bottom: 1em;
}

a.select_all, a.unselect_all {
    cursor: pointer;
}</code>
</property>
<property>
<name>Check programming style</name>
</property>
<property>
<parse>0</parse>
</property>
<property>
<use>currentPage</use>
</property>
</object>
<content>{{groovy}}
xwiki.ssx.use(doc.getFullName())
xwiki.jsx.use(doc.getFullName())

if (!"post".equalsIgnoreCase(request.getMethod())) {
    printForm(pageListPerWiki())
} else if (!services.csrf.isTokenValid(request.getParameter('form_token'))) {
    response.sendRedirect(services.csrf.getResubmissionURL())
} else {
    savePages(request.getParameterValues('pagelist'))
}

def pageListPerWiki()
{
    def wikilist =  xwiki.isVirtualMode() ? xwiki.getPlugin("wikimanager")?.getAllWikis() : [ "xwiki" ];
    def knownpageslist = [
        "AnnotationCode.Script",
        "AnnotationCode.Settings",
        "AnnotationCode.Style",
        "Main.Activity",
        "Main.SpaceIndex",
        "Main.Spaces",
        "XWiki.AllAttachments",
    ];

    def context2 = xcontext.getContext()
    def db = context2.getDatabase()

    def wikiPagelists = [:]
     
    try {
        for (wiki in wikilist) {
            def wikiname = wiki.toString()
            context2.setDatabase(wikiname)
            // get all the pages which have a required rights object
            // attached to them, that specifies either edit or
            // programming
            def pagelist = services.query.xwql("select distinct doc.fullName from Document doc, doc.object(XWiki.RequiredRightClass) as reqRight where reqRight.level = 'programming' or reqRight.level = 'edit'").execute()
            // add the known pages that need to be saved with programming
            // || edit rights to the list of pages, if they don't have the '
            // required rights object
            for (knownpage in knownpageslist) {
                if (!pagelist.contains(knownpage) &amp;&amp; xwiki.exists(knownpage)) {
                    pagelist.add(knownpage)  
                } 
            }

            def rs = xwiki.getXWiki().getRightService()

            wikiPagelists[wikiname] = pagelist.findAll{
                name -&gt; !rs.hasProgrammingRights(xwiki.getDocument(name).getDocument(), context2) ||
                    needsRequiredRightsObj(xwiki.getDocument(name))
            }

        }
    } finally {
        context2.setDatabase(db)
    }

    return wikiPagelists
}

def printForm(pagelistPerWiki)
{
    
    println "{{info}} You need to run this with a user that has programming rights, otherwise it will have no effect. {{/info}}\n\n"

    println("""\
{{html}}
&lt;span class=\"buttonwrapper\"&gt;
&lt;a id=\"select_all_all_wikis\" class=\"select_all\"&gt;select all in all wikis&lt;/a&gt;
&lt;/span&gt;
&lt;span class=\"buttonwrapper\"&gt;
&lt;a id=\"unselect_all_all_wikis\" class=\"unselect_all\"&gt;select none&lt;/a&gt;
&lt;/span&gt;
&lt;form action=\"${xwiki.getURL(doc.getFullName())}\" method=\"post\" &gt;
&lt;input type=\"hidden\" name=\"form_token\" value=\"${services.csrf.token}\" /&gt;
""")

    for (wikiname in pagelistPerWiki.keySet()) {
        if (pagelistPerWiki.get(wikiname).size() == 0) {
            continue
        }
        println("&lt;fieldset id=\"pagelist:${wikiname}\" class=\"pagelist\" &gt;")
        println("&lt;h2&gt;&lt;legend class=\"wikiname\"&gt;Wiki: ${wikiname}&lt;/legend&gt;&lt;/h2&gt;")
        println("""\
&lt;div class=\"select_checkbox_control\"&gt;
&lt;span class=\"buttonwrapper\"&gt;
&lt;a id=\"select_all:${wikiname}\" class=\"select_all\"&gt;select all&lt;/a&gt;
&lt;/span&gt;
&lt;span class=\"buttonwrapper\"&gt;
&lt;a id=\"unselect_all:${wikiname}\" class=\"unselect_all\"&gt;select none&lt;/a&gt;
&lt;/span&gt;
&lt;/div&gt;
""")
        println("&lt;div&gt;")
        for (page in pagelistPerWiki.get(wikiname)) {
            println("""\
&lt;div class=\"page_checkbox_item\"&gt;
&lt;input type=\"checkbox\" name=\"pagelist\" id=\"page_${wikiname}_${page}\"
       class=\"${wikiname}_page\" value=\"${wikiname}:${page}\"/&gt;
 &lt;a href=\"${xwiki.getURL(wikiname + ':' + page)}?viewer=code\"&gt;${page}&lt;/a&gt; 
&lt;/div&gt;
""")
        }
        println("&lt;/div&gt;")
        println("&lt;/fieldset&gt;")
    }

    println("""\
&lt;hr /&gt;
&lt;span class=\"buttonwrapper\"&gt;
&lt;input class=\"button\" type=\"submit\" value=\"save with programming rights\" /&gt;
&lt;/span&gt;
&lt;/form&gt;
{{/html}}
""")

}

def addDenyEdit(prDoc)
{
    def rightObjs = prDoc.getObjects('XWiki.XWikiRights')

    def addGroup = true
    def addUser  = true

    if (rightObjs != null) {
        for (rightObj in rightObjs.findAll{ o -&gt; o.get('levels').split(' ').count('edit') &gt; 0}) {
            def users = rightObj.getProperty('users')?.getValue()?.split(' ')
            def groups = rightObj.getProperty('groups')?.getValue()?.split(' ')
            if (rightObj.getProperty('allow').getValue() == 1) {
                if (users != null &amp;&amp; users.count('XWiki.XWikiGuest') &gt; 0) {
                    rightObj.set('users', users.findAll{ user -&gt; user != 'XWiki.XWikiGuest' }.join(' '))
                }
                if (groups != null &amp;&amp; groups.count('XWiki.XWikiAllGroup') &gt; 0) {
                    rightObj.set('groups', groups.findAll{ group -&gt; group != 'XWiki.XWikiAllGroup' }.join(' '))
                }
            } else {
                if (users != null &amp;&amp; users.count('XWiki.XWikiGuest') &gt; 0) {
                    addUser = false;
                }
                if (groups != null &amp;&amp; groups.count('XWiki.XWikiAllGroup') &gt; 0) {
                    addGroup = false;
                }
            }
        }
    }

    if (addUser || addGroup) {
        def obj = prDoc.newObject('XWiki.XWikiRights')
        obj.set('allow', 0)
        obj.set('levels', 'edit')
        if (addUser) {
            obj.set('users', 'XWiki.XWikiGuest')
        }
        if (addGroup) {
            obj.set('groups', 'XWiki.XWikiAllGroup')
        }
    }
}

def needsRequiredRightsObj(prDoc)
{
    def objList = prDoc.getObjects('XWiki.RequiredRightClass');
    return objList == null || objList.findAll{
        obj -&gt; obj.getProperty('level').getValue() == 'programming' ||
            obj.getProperty('level').getValue() == 'edit'
    }.size() == 0
}

def addRequiredRightProgramming(prDoc)
{
    if (needsRequiredRightsObj(prDoc)) {
        def reqRight = prDoc.newObject('XWiki.RequiredRightClass')
        reqRight.set('level', 'programming')
    }
}

def savePages(pagelist) {
    for (page in pagelist) {
        prDoc = xwiki.getDocument(page)
        addDenyEdit(prDoc)
        addRequiredRightProgramming(prDoc)
        try {
            prDoc.save('Saving with programming rights.', true)
            println " * Successfully saved '${page}'"
        } catch (Exception e) {
            println " * Failed to save '${page}': " + e
        }
    }
}
{{/groovy}}
</content><versions>head	1.1;
access;
symbols;
locks; strict;
comment	@# @;


1.1
date	2012.11.17.14.06.51;	author XWiki_2EAdmin;	state full;
branches;
next	;


desc
@@


1.1
log
@Imported from XAR
@
text
@&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;xwikidoc&gt;
&lt;web&gt;Admin&lt;/web&gt;
&lt;name&gt;CheckProgrammingRights&lt;/name&gt;
&lt;language&gt;&lt;/language&gt;
&lt;defaultLanguage&gt;&lt;/defaultLanguage&gt;
&lt;translation&gt;0&lt;/translation&gt;
&lt;parent&gt;Admin.WebHome&lt;/parent&gt;
&lt;creator&gt;XWiki.Admin&lt;/creator&gt;
&lt;author&gt;XWiki.Admin&lt;/author&gt;
&lt;customClass&gt;&lt;/customClass&gt;
&lt;contentAuthor&gt;XWiki.Admin&lt;/contentAuthor&gt;
&lt;creationDate&gt;1374224638000&lt;/creationDate&gt;
&lt;date&gt;1353157611000&lt;/date&gt;
&lt;contentUpdateDate&gt;1353157611000&lt;/contentUpdateDate&gt;
&lt;version&gt;1.1&lt;/version&gt;
&lt;title&gt;Check programming rights&lt;/title&gt;
&lt;defaultTemplate&gt;&lt;/defaultTemplate&gt;
&lt;validationScript&gt;&lt;/validationScript&gt;
&lt;comment&gt;Imported from XAR&lt;/comment&gt;
&lt;minorEdit&gt;false&lt;/minorEdit&gt;
&lt;syntaxId&gt;xwiki/2.0&lt;/syntaxId&gt;
&lt;hidden&gt;false&lt;/hidden&gt;
&lt;object&gt;
&lt;class&gt;
&lt;name&gt;XWiki.JavaScriptExtension&lt;/name&gt;
&lt;customClass&gt;&lt;/customClass&gt;
&lt;customMapping&gt;&lt;/customMapping&gt;
&lt;defaultViewSheet&gt;&lt;/defaultViewSheet&gt;
&lt;defaultEditSheet&gt;&lt;/defaultEditSheet&gt;
&lt;defaultWeb&gt;&lt;/defaultWeb&gt;
&lt;nameField&gt;&lt;/nameField&gt;
&lt;validationScript&gt;&lt;/validationScript&gt;
&lt;cache&gt;
&lt;cache&gt;0&lt;/cache&gt;
&lt;disabled&gt;0&lt;/disabled&gt;
&lt;displayType&gt;select&lt;/displayType&gt;
&lt;multiSelect&gt;0&lt;/multiSelect&gt;
&lt;name&gt;cache&lt;/name&gt;
&lt;number&gt;5&lt;/number&gt;
&lt;prettyName&gt;Caching policy&lt;/prettyName&gt;
&lt;relationalStorage&gt;0&lt;/relationalStorage&gt;
&lt;separator&gt; &lt;/separator&gt;
&lt;separators&gt; ,|&lt;/separators&gt;
&lt;size&gt;1&lt;/size&gt;
&lt;unmodifiable&gt;0&lt;/unmodifiable&gt;
&lt;values&gt;long|short|default|forbid&lt;/values&gt;
&lt;classType&gt;com.xpn.xwiki.objects.classes.StaticListClass&lt;/classType&gt;
&lt;/cache&gt;
&lt;code&gt;
&lt;disabled&gt;0&lt;/disabled&gt;
&lt;name&gt;code&lt;/name&gt;
&lt;number&gt;2&lt;/number&gt;
&lt;prettyName&gt;Code&lt;/prettyName&gt;
&lt;rows&gt;20&lt;/rows&gt;
&lt;size&gt;50&lt;/size&gt;
&lt;unmodifiable&gt;0&lt;/unmodifiable&gt;
&lt;classType&gt;com.xpn.xwiki.objects.classes.TextAreaClass&lt;/classType&gt;
&lt;/code&gt;
&lt;name&gt;
&lt;disabled&gt;0&lt;/disabled&gt;
&lt;name&gt;name&lt;/name&gt;
&lt;number&gt;1&lt;/number&gt;
&lt;prettyName&gt;Name&lt;/prettyName&gt;
&lt;size&gt;30&lt;/size&gt;
&lt;unmodifiable&gt;0&lt;/unmodifiable&gt;
&lt;classType&gt;com.xpn.xwiki.objects.classes.StringClass&lt;/classType&gt;
&lt;/name&gt;
&lt;parse&gt;
&lt;disabled&gt;0&lt;/disabled&gt;
&lt;displayFormType&gt;select&lt;/displayFormType&gt;
&lt;displayType&gt;yesno&lt;/displayType&gt;
&lt;name&gt;parse&lt;/name&gt;
&lt;number&gt;4&lt;/number&gt;
&lt;prettyName&gt;Parse content&lt;/prettyName&gt;
&lt;unmodifiable&gt;0&lt;/unmodifiable&gt;
&lt;classType&gt;com.xpn.xwiki.objects.classes.BooleanClass&lt;/classType&gt;
&lt;/parse&gt;
&lt;use&gt;
&lt;cache&gt;0&lt;/cache&gt;
&lt;disabled&gt;0&lt;/disabled&gt;
&lt;displayType&gt;select&lt;/displayType&gt;
&lt;multiSelect&gt;0&lt;/multiSelect&gt;
&lt;name&gt;use&lt;/name&gt;
&lt;number&gt;3&lt;/number&gt;
&lt;prettyName&gt;Use this extension&lt;/prettyName&gt;
&lt;relationalStorage&gt;0&lt;/relationalStorage&gt;
&lt;separator&gt; &lt;/separator&gt;
&lt;separators&gt; ,|&lt;/separators&gt;
&lt;size&gt;1&lt;/size&gt;
&lt;unmodifiable&gt;0&lt;/unmodifiable&gt;
&lt;values&gt;currentPage=Always on this page|onDemand=On demand|always=Always on this wiki&lt;/values&gt;
&lt;classType&gt;com.xpn.xwiki.objects.classes.StaticListClass&lt;/classType&gt;
&lt;/use&gt;
&lt;/class&gt;
&lt;name&gt;Admin.CheckProgrammingRights&lt;/name&gt;
&lt;number&gt;0&lt;/number&gt;
&lt;className&gt;XWiki.JavaScriptExtension&lt;/className&gt;
&lt;guid&gt;18d70e37-7b7c-476b-911c-39a22da0e9bd&lt;/guid&gt;
&lt;property&gt;
&lt;cache&gt;forbid&lt;/cache&gt;
&lt;/property&gt;
&lt;property&gt;
&lt;code&gt;document.observe("xwiki:dom:loaded", function() {

    var handleSelect = function(event, checked) {
        var fragments = event.findElement().identify().split(':');
        if (fragments.length == 2) {
            var wikiname = fragments[1];
            var id = 'pagelist:' + wikiname;
            var selector = '#' + id;

            $(id).select('input[name=pagelist]').each(function (input) {
                input.checked = checked;
            });
        } else {
            $$('input[name=pagelist]').each(function (input) {
                input.checked = checked;
            });
        }
    };

    $$('.unselect_all').each(function (element) {
        element.observe('click', function (event) {
            handleSelect(event, false);
        });
    });

    $$('.select_all').each(function (element) {
        element.observe('click', function (event) {
            handleSelect(event, true);
        });
    });
});&lt;/code&gt;
&lt;/property&gt;
&lt;property&gt;
&lt;name&gt;Checkbox control&lt;/name&gt;
&lt;/property&gt;
&lt;property&gt;
&lt;parse&gt;0&lt;/parse&gt;
&lt;/property&gt;
&lt;property&gt;
&lt;use&gt;currentPage&lt;/use&gt;
&lt;/property&gt;
&lt;/object&gt;
&lt;object&gt;
&lt;class&gt;
&lt;name&gt;XWiki.RequiredRightClass&lt;/name&gt;
&lt;customClass&gt;&lt;/customClass&gt;
&lt;customMapping&gt;&lt;/customMapping&gt;
&lt;defaultViewSheet&gt;&lt;/defaultViewSheet&gt;
&lt;defaultEditSheet&gt;&lt;/defaultEditSheet&gt;
&lt;defaultWeb&gt;&lt;/defaultWeb&gt;
&lt;nameField&gt;&lt;/nameField&gt;
&lt;validationScript&gt;&lt;/validationScript&gt;
&lt;level&gt;
&lt;cache&gt;0&lt;/cache&gt;
&lt;disabled&gt;0&lt;/disabled&gt;
&lt;displayType&gt;select&lt;/displayType&gt;
&lt;multiSelect&gt;0&lt;/multiSelect&gt;
&lt;name&gt;level&lt;/name&gt;
&lt;number&gt;1&lt;/number&gt;
&lt;picker&gt;0&lt;/picker&gt;
&lt;prettyName&gt;level&lt;/prettyName&gt;
&lt;relationalStorage&gt;0&lt;/relationalStorage&gt;
&lt;separator&gt; &lt;/separator&gt;
&lt;separators&gt; ,|&lt;/separators&gt;
&lt;size&gt;1&lt;/size&gt;
&lt;sort&gt;none&lt;/sort&gt;
&lt;unmodifiable&gt;0&lt;/unmodifiable&gt;
&lt;validationMessage&gt;&lt;/validationMessage&gt;
&lt;validationRegExp&gt;&lt;/validationRegExp&gt;
&lt;values&gt;edit|programming&lt;/values&gt;
&lt;classType&gt;com.xpn.xwiki.objects.classes.StaticListClass&lt;/classType&gt;
&lt;/level&gt;
&lt;/class&gt;
&lt;name&gt;Admin.CheckProgrammingRights&lt;/name&gt;
&lt;number&gt;0&lt;/number&gt;
&lt;className&gt;XWiki.RequiredRightClass&lt;/className&gt;
&lt;guid&gt;2e93c625-8350-4ca0-8437-90153c3394d5&lt;/guid&gt;
&lt;property&gt;
&lt;level&gt;programming&lt;/level&gt;
&lt;/property&gt;
&lt;/object&gt;
&lt;object&gt;
&lt;class&gt;
&lt;name&gt;XWiki.StyleSheetExtension&lt;/name&gt;
&lt;customClass&gt;&lt;/customClass&gt;
&lt;customMapping&gt;&lt;/customMapping&gt;
&lt;defaultViewSheet&gt;&lt;/defaultViewSheet&gt;
&lt;defaultEditSheet&gt;&lt;/defaultEditSheet&gt;
&lt;defaultWeb&gt;&lt;/defaultWeb&gt;
&lt;nameField&gt;&lt;/nameField&gt;
&lt;validationScript&gt;&lt;/validationScript&gt;
&lt;cache&gt;
&lt;cache&gt;0&lt;/cache&gt;
&lt;disabled&gt;0&lt;/disabled&gt;
&lt;displayType&gt;select&lt;/displayType&gt;
&lt;multiSelect&gt;0&lt;/multiSelect&gt;
&lt;name&gt;cache&lt;/name&gt;
&lt;number&gt;5&lt;/number&gt;
&lt;prettyName&gt;Caching policy&lt;/prettyName&gt;
&lt;relationalStorage&gt;0&lt;/relationalStorage&gt;
&lt;separator&gt; &lt;/separator&gt;
&lt;separators&gt; ,|&lt;/separators&gt;
&lt;size&gt;1&lt;/size&gt;
&lt;unmodifiable&gt;0&lt;/unmodifiable&gt;
&lt;values&gt;long|short|default|forbid&lt;/values&gt;
&lt;classType&gt;com.xpn.xwiki.objects.classes.StaticListClass&lt;/classType&gt;
&lt;/cache&gt;
&lt;code&gt;
&lt;disabled&gt;0&lt;/disabled&gt;
&lt;name&gt;code&lt;/name&gt;
&lt;number&gt;2&lt;/number&gt;
&lt;prettyName&gt;Code&lt;/prettyName&gt;
&lt;rows&gt;20&lt;/rows&gt;
&lt;size&gt;50&lt;/size&gt;
&lt;unmodifiable&gt;0&lt;/unmodifiable&gt;
&lt;classType&gt;com.xpn.xwiki.objects.classes.TextAreaClass&lt;/classType&gt;
&lt;/code&gt;
&lt;name&gt;
&lt;disabled&gt;0&lt;/disabled&gt;
&lt;name&gt;name&lt;/name&gt;
&lt;number&gt;1&lt;/number&gt;
&lt;prettyName&gt;Name&lt;/prettyName&gt;
&lt;size&gt;30&lt;/size&gt;
&lt;unmodifiable&gt;0&lt;/unmodifiable&gt;
&lt;classType&gt;com.xpn.xwiki.objects.classes.StringClass&lt;/classType&gt;
&lt;/name&gt;
&lt;parse&gt;
&lt;disabled&gt;0&lt;/disabled&gt;
&lt;displayFormType&gt;select&lt;/displayFormType&gt;
&lt;displayType&gt;yesno&lt;/displayType&gt;
&lt;name&gt;parse&lt;/name&gt;
&lt;number&gt;4&lt;/number&gt;
&lt;prettyName&gt;Parse content&lt;/prettyName&gt;
&lt;unmodifiable&gt;0&lt;/unmodifiable&gt;
&lt;classType&gt;com.xpn.xwiki.objects.classes.BooleanClass&lt;/classType&gt;
&lt;/parse&gt;
&lt;use&gt;
&lt;cache&gt;0&lt;/cache&gt;
&lt;disabled&gt;0&lt;/disabled&gt;
&lt;displayType&gt;select&lt;/displayType&gt;
&lt;multiSelect&gt;0&lt;/multiSelect&gt;
&lt;name&gt;use&lt;/name&gt;
&lt;number&gt;3&lt;/number&gt;
&lt;prettyName&gt;Use this extension&lt;/prettyName&gt;
&lt;relationalStorage&gt;0&lt;/relationalStorage&gt;
&lt;separator&gt; &lt;/separator&gt;
&lt;separators&gt; ,|&lt;/separators&gt;
&lt;size&gt;1&lt;/size&gt;
&lt;unmodifiable&gt;0&lt;/unmodifiable&gt;
&lt;values&gt;currentPage=Always on this page|onDemand=On demand|always=Always on this wiki&lt;/values&gt;
&lt;classType&gt;com.xpn.xwiki.objects.classes.StaticListClass&lt;/classType&gt;
&lt;/use&gt;
&lt;/class&gt;
&lt;name&gt;Admin.CheckProgrammingRights&lt;/name&gt;
&lt;number&gt;0&lt;/number&gt;
&lt;className&gt;XWiki.StyleSheetExtension&lt;/className&gt;
&lt;guid&gt;01831ba2-9cb5-4583-9e14-7812fe173615&lt;/guid&gt;
&lt;property&gt;
&lt;cache&gt;forbid&lt;/cache&gt;
&lt;/property&gt;
&lt;property&gt;
&lt;code&gt;legend.wikiname {
    font-size: larger;
    padding-top: 0.5em;
    padding-bottom: 0.5em;
}

div.select_checkbox_control {
    margin-bottom: 1em;
}

a.select_all, a.unselect_all {
    cursor: pointer;
}&lt;/code&gt;
&lt;/property&gt;
&lt;property&gt;
&lt;name&gt;Check programming style&lt;/name&gt;
&lt;/property&gt;
&lt;property&gt;
&lt;parse&gt;0&lt;/parse&gt;
&lt;/property&gt;
&lt;property&gt;
&lt;use&gt;currentPage&lt;/use&gt;
&lt;/property&gt;
&lt;/object&gt;
&lt;content&gt;{{groovy}}
xwiki.ssx.use(doc.getFullName())
xwiki.jsx.use(doc.getFullName())

if (!"post".equalsIgnoreCase(request.getMethod())) {
    printForm(pageListPerWiki())
} else if (!services.csrf.isTokenValid(request.getParameter('form_token'))) {
    response.sendRedirect(services.csrf.getResubmissionURL())
} else {
    savePages(request.getParameterValues('pagelist'))
}

def pageListPerWiki()
{
    def wikilist =  xwiki.isVirtualMode() ? xwiki.getPlugin("wikimanager")?.getAllWikis() : [ "xwiki" ];
    def knownpageslist = [
        "AnnotationCode.Script",
        "AnnotationCode.Settings",
        "AnnotationCode.Style",
        "Main.Activity",
        "Main.SpaceIndex",
        "Main.Spaces",
        "XWiki.AllAttachments",
    ];

    def context2 = xcontext.getContext()
    def db = context2.getDatabase()

    def wikiPagelists = [:]
     
    try {
        for (wiki in wikilist) {
            def wikiname = wiki.toString()
            context2.setDatabase(wikiname)
            // get all the pages which have a required rights object
            // attached to them, that specifies either edit or
            // programming
            def pagelist = services.query.xwql("select distinct doc.fullName from Document doc, doc.object(XWiki.RequiredRightClass) as reqRight where reqRight.level = 'programming' or reqRight.level = 'edit'").execute()
            // add the known pages that need to be saved with programming
            // || edit rights to the list of pages, if they don't have the '
            // required rights object
            for (knownpage in knownpageslist) {
                if (!pagelist.contains(knownpage) &amp;amp;&amp;amp; xwiki.exists(knownpage)) {
                    pagelist.add(knownpage)  
                } 
            }

            def rs = xwiki.getXWiki().getRightService()

            wikiPagelists[wikiname] = pagelist.findAll{
                name -&amp;gt; !rs.hasProgrammingRights(xwiki.getDocument(name).getDocument(), context2) ||
                    needsRequiredRightsObj(xwiki.getDocument(name))
            }

        }
    } finally {
        context2.setDatabase(db)
    }

    return wikiPagelists
}

def printForm(pagelistPerWiki)
{
    
    println "{{info}} You need to run this with a user that has programming rights, otherwise it will have no effect. {{/info}}\n\n"

    println("""\
{{html}}
&amp;lt;span class=\"buttonwrapper\"&amp;gt;
&amp;lt;a id=\"select_all_all_wikis\" class=\"select_all\"&amp;gt;select all in all wikis&amp;lt;/a&amp;gt;
&amp;lt;/span&amp;gt;
&amp;lt;span class=\"buttonwrapper\"&amp;gt;
&amp;lt;a id=\"unselect_all_all_wikis\" class=\"unselect_all\"&amp;gt;select none&amp;lt;/a&amp;gt;
&amp;lt;/span&amp;gt;
&amp;lt;form action=\"${xwiki.getURL(doc.getFullName())}\" method=\"post\" &amp;gt;
&amp;lt;input type=\"hidden\" name=\"form_token\" value=\"${services.csrf.token}\" /&amp;gt;
""")

    for (wikiname in pagelistPerWiki.keySet()) {
        if (pagelistPerWiki.get(wikiname).size() == 0) {
            continue
        }
        println("&amp;lt;fieldset id=\"pagelist:${wikiname}\" class=\"pagelist\" &amp;gt;")
        println("&amp;lt;h2&amp;gt;&amp;lt;legend class=\"wikiname\"&amp;gt;Wiki: ${wikiname}&amp;lt;/legend&amp;gt;&amp;lt;/h2&amp;gt;")
        println("""\
&amp;lt;div class=\"select_checkbox_control\"&amp;gt;
&amp;lt;span class=\"buttonwrapper\"&amp;gt;
&amp;lt;a id=\"select_all:${wikiname}\" class=\"select_all\"&amp;gt;select all&amp;lt;/a&amp;gt;
&amp;lt;/span&amp;gt;
&amp;lt;span class=\"buttonwrapper\"&amp;gt;
&amp;lt;a id=\"unselect_all:${wikiname}\" class=\"unselect_all\"&amp;gt;select none&amp;lt;/a&amp;gt;
&amp;lt;/span&amp;gt;
&amp;lt;/div&amp;gt;
""")
        println("&amp;lt;div&amp;gt;")
        for (page in pagelistPerWiki.get(wikiname)) {
            println("""\
&amp;lt;div class=\"page_checkbox_item\"&amp;gt;
&amp;lt;input type=\"checkbox\" name=\"pagelist\" id=\"page_${wikiname}_${page}\"
       class=\"${wikiname}_page\" value=\"${wikiname}:${page}\"/&amp;gt;
 &amp;lt;a href=\"${xwiki.getURL(wikiname + ':' + page)}?viewer=code\"&amp;gt;${page}&amp;lt;/a&amp;gt; 
&amp;lt;/div&amp;gt;
""")
        }
        println("&amp;lt;/div&amp;gt;")
        println("&amp;lt;/fieldset&amp;gt;")
    }

    println("""\
&amp;lt;hr /&amp;gt;
&amp;lt;span class=\"buttonwrapper\"&amp;gt;
&amp;lt;input class=\"button\" type=\"submit\" value=\"save with programming rights\" /&amp;gt;
&amp;lt;/span&amp;gt;
&amp;lt;/form&amp;gt;
{{/html}}
""")

}

def addDenyEdit(prDoc)
{
    def rightObjs = prDoc.getObjects('XWiki.XWikiRights')

    def addGroup = true
    def addUser  = true

    if (rightObjs != null) {
        for (rightObj in rightObjs.findAll{ o -&amp;gt; o.get('levels').split(' ').count('edit') &amp;gt; 0}) {
            def users = rightObj.getProperty('users')?.getValue()?.split(' ')
            def groups = rightObj.getProperty('groups')?.getValue()?.split(' ')
            if (rightObj.getProperty('allow').getValue() == 1) {
                if (users != null &amp;amp;&amp;amp; users.count('XWiki.XWikiGuest') &amp;gt; 0) {
                    rightObj.set('users', users.findAll{ user -&amp;gt; user != 'XWiki.XWikiGuest' }.join(' '))
                }
                if (groups != null &amp;amp;&amp;amp; groups.count('XWiki.XWikiAllGroup') &amp;gt; 0) {
                    rightObj.set('groups', groups.findAll{ group -&amp;gt; group != 'XWiki.XWikiAllGroup' }.join(' '))
                }
            } else {
                if (users != null &amp;amp;&amp;amp; users.count('XWiki.XWikiGuest') &amp;gt; 0) {
                    addUser = false;
                }
                if (groups != null &amp;amp;&amp;amp; groups.count('XWiki.XWikiAllGroup') &amp;gt; 0) {
                    addGroup = false;
                }
            }
        }
    }

    if (addUser || addGroup) {
        def obj = prDoc.newObject('XWiki.XWikiRights')
        obj.set('allow', 0)
        obj.set('levels', 'edit')
        if (addUser) {
            obj.set('users', 'XWiki.XWikiGuest')
        }
        if (addGroup) {
            obj.set('groups', 'XWiki.XWikiAllGroup')
        }
    }
}

def needsRequiredRightsObj(prDoc)
{
    def objList = prDoc.getObjects('XWiki.RequiredRightClass');
    return objList == null || objList.findAll{
        obj -&amp;gt; obj.getProperty('level').getValue() == 'programming' ||
            obj.getProperty('level').getValue() == 'edit'
    }.size() == 0
}

def addRequiredRightProgramming(prDoc)
{
    if (needsRequiredRightsObj(prDoc)) {
        def reqRight = prDoc.newObject('XWiki.RequiredRightClass')
        reqRight.set('level', 'programming')
    }
}

def savePages(pagelist) {
    for (page in pagelist) {
        prDoc = xwiki.getDocument(page)
        addDenyEdit(prDoc)
        addRequiredRightProgramming(prDoc)
        try {
            prDoc.save('Saving with programming rights.', true)
            println " * Successfully saved '${page}'"
        } catch (Exception e) {
            println " * Failed to save '${page}': " + e
        }
    }
}
{{/groovy}}
&lt;/content&gt;&lt;/xwikidoc&gt;@
</versions></xwikidoc>