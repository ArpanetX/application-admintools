<?xml version="1.0" encoding="UTF-8"?>
<xwikidoc>
<web>Admin</web>
<name>WikiDiffGroovy</name>
<language></language>
<defaultLanguage></defaultLanguage>
<translation>0</translation>
<parent>Admin.WebHome</parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1374224648000</creationDate>
<date>1262300400000</date>
<contentUpdateDate>1262300400000</contentUpdateDate>
<version>1.1</version>
<title></title>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment>Imported from XAR</comment>
<minorEdit>false</minorEdit>
<syntaxId>xwiki/2.0</syntaxId>
<hidden>false</hidden>
<content>/* Groovy Class #* */

import java.util.*
import java.net.URL;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.Map;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;
import java.io.*;
import com.xpn.xwiki.doc.XWikiDocument;
import com.xpn.xwiki.api.Document;

class Diff {
  def xwiki;
  def context;

  public setContext(context, xwiki) {
    this.xwiki = xwiki
    this.context = context
  }

  public clean1(content) {
    return content.replaceAll("\r", "").replaceAll("\n", "").replaceAll("(?s)&lt;attachment&gt;(.*?)&lt;content&gt;(.*?)&lt;/content&gt;(.*?)&lt;/attachment&gt;", "&lt;attachment&gt;\$1&lt;content&gt;&lt;/content&gt;\$3&lt;/attachment&gt;").replaceAll("(?s)&lt;guid&gt;(.*?)&lt;/guid&gt;", "&lt;guid&gt;&lt;/guid&gt;")
  }

  public clean2(content) {
    return content.replaceAll("\r", "").replaceAll("(?s)&lt;attachment&gt;(.*?)&lt;content&gt;(.*?)&lt;/content&gt;(.*?)&lt;/attachment&gt;", "&lt;attachment&gt;\$1&lt;content&gt;&lt;/content&gt;\$3&lt;/attachment&gt;").replaceAll("(?s)&lt;guid&gt;(.*?)&lt;/guid&gt;", "&lt;guid&gt;&lt;/guid&gt;")
  }
 
  public save(filename, content, bclean) {
   FileOutputStream fis = new FileOutputStream(new File("/tmp/${filename}"));
   def data = (bclean) ? clean1(content) : content
   fis.write(data.getBytes());
   fis.close();
  }

  boolean compare(oldContent, newContent) {
        oldContent = clean1(oldContent)
        newContent = clean1(newContent)
        return !oldContent.equals(newContent);
  }

  String diff(def oldContent, def newContent) {
        oldContent = clean2(oldContent)
        newContent = clean2(newContent)
        return xwiki.diff.getDifferencesAsHTML(oldContent, newContent, false);
  }

  public getDocument(content) {
      def newdoc = new XWikiDocument();
      newdoc.fromXML(content);
      return new Document(newdoc, context.getContext());
  }

  public getXMLFromString(content) {
      def newdoc = new XWikiDocument();
      newdoc.fromXML(content);
      return getXML2(newdoc);
  }

  public getXML(pagedoc) {
      def clonedDoc = pagedoc.document.clone();
      return getXML2(clonedDoc);
  }

  public getXML2(clonedDoc) {
        def defaultUser = "XWiki.Admin";
        def defaultDate = new Date("01/01/2010");

        // remove Tag object
        if (clonedDoc.getObject("XWiki.TagClass")) {
          clonedDoc.removeObject(clonedDoc.getObject("XWiki.TagClass"));
        }

        if (defaultUser &amp;&amp; defaultUser!="") {
          clonedDoc.setCreator(defaultUser);
          clonedDoc.setContentAuthor(defaultUser);
          clonedDoc.setAuthor(defaultUser);
        } else {
          clonedDoc.setCreator(clonedDoc.getAuthor());
          clonedDoc.setContentAuthor(clonedDoc.getAuthor());
        }
    
        if (defaultDate &amp;&amp; defaultDate!="") {
          clonedDoc.setCreationDate(defaultDate);
          clonedDoc.setContentUpdateDate(defaultDate);
          clonedDoc.setDate(defaultDate);
          clonedDoc.setVersion("1.1");
        } else {
          clonedDoc.setContentUpdateDate(clonedDoc.getDate())
          clonedDoc.setCreationDate(clonedDoc.getDate())
          clonedDoc.setVersion("1.1");
        }  
        clonedDoc.setComment("");
        clonedDoc.setMinorEdit(false);
        def c = clonedDoc.toXML(true, false, true, false, context.getContext())
        return c.trim().replaceAll("[\r]","");
    }

    Map&lt;String, String&gt; getZipContent(String url) throws Exception
    {
        Map&lt;String, String&gt; zipContent = new HashMap&lt;String, String&gt;();
        
        ZipInputStream zis = new ZipInputStream(new URL(url).openStream());
        byte[] buffer = new byte[2048];
        ZipEntry entry;
        while ((entry = zis.getNextEntry()) != null) {
            StringBuffer content = new StringBuffer();  
            int len = 0;
            while ((len = zis.read(buffer)) &gt; 0)
            {
                content.append(new String(buffer, 0, len));
            }
            zipContent.put(entry.getName(), content.toString());
        }
        zis.close();
        
        return zipContent;
    }

}

/* *# */</content>
<versions>head	1.1;
access;
symbols;
locks; strict;
comment	@# @;


1.1
date	2010.01.01.00.00.00;	author XWiki_2EAdmin;	state full;
branches;
next	;


desc
@@


1.1
log
@Imported from XAR
@
text
@&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;xwikidoc&gt;
&lt;web&gt;Admin&lt;/web&gt;
&lt;name&gt;WikiDiffGroovy&lt;/name&gt;
&lt;language&gt;&lt;/language&gt;
&lt;defaultLanguage&gt;&lt;/defaultLanguage&gt;
&lt;translation&gt;0&lt;/translation&gt;
&lt;parent&gt;Admin.WebHome&lt;/parent&gt;
&lt;creator&gt;XWiki.Admin&lt;/creator&gt;
&lt;author&gt;XWiki.Admin&lt;/author&gt;
&lt;customClass&gt;&lt;/customClass&gt;
&lt;contentAuthor&gt;XWiki.Admin&lt;/contentAuthor&gt;
&lt;creationDate&gt;1374224648000&lt;/creationDate&gt;
&lt;date&gt;1262300400000&lt;/date&gt;
&lt;contentUpdateDate&gt;1262300400000&lt;/contentUpdateDate&gt;
&lt;version&gt;1.1&lt;/version&gt;
&lt;title&gt;&lt;/title&gt;
&lt;defaultTemplate&gt;&lt;/defaultTemplate&gt;
&lt;validationScript&gt;&lt;/validationScript&gt;
&lt;comment&gt;Imported from XAR&lt;/comment&gt;
&lt;minorEdit&gt;false&lt;/minorEdit&gt;
&lt;syntaxId&gt;xwiki/2.0&lt;/syntaxId&gt;
&lt;hidden&gt;false&lt;/hidden&gt;
&lt;content&gt;/* Groovy Class #* */

import java.util.*
import java.net.URL;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.Map;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;
import java.io.*;
import com.xpn.xwiki.doc.XWikiDocument;
import com.xpn.xwiki.api.Document;

class Diff {
  def xwiki;
  def context;

  public setContext(context, xwiki) {
    this.xwiki = xwiki
    this.context = context
  }

  public clean1(content) {
    return content.replaceAll("\r", "").replaceAll("\n", "").replaceAll("(?s)&amp;lt;attachment&amp;gt;(.*?)&amp;lt;content&amp;gt;(.*?)&amp;lt;/content&amp;gt;(.*?)&amp;lt;/attachment&amp;gt;", "&amp;lt;attachment&amp;gt;\$1&amp;lt;content&amp;gt;&amp;lt;/content&amp;gt;\$3&amp;lt;/attachment&amp;gt;").replaceAll("(?s)&amp;lt;guid&amp;gt;(.*?)&amp;lt;/guid&amp;gt;", "&amp;lt;guid&amp;gt;&amp;lt;/guid&amp;gt;")
  }

  public clean2(content) {
    return content.replaceAll("\r", "").replaceAll("(?s)&amp;lt;attachment&amp;gt;(.*?)&amp;lt;content&amp;gt;(.*?)&amp;lt;/content&amp;gt;(.*?)&amp;lt;/attachment&amp;gt;", "&amp;lt;attachment&amp;gt;\$1&amp;lt;content&amp;gt;&amp;lt;/content&amp;gt;\$3&amp;lt;/attachment&amp;gt;").replaceAll("(?s)&amp;lt;guid&amp;gt;(.*?)&amp;lt;/guid&amp;gt;", "&amp;lt;guid&amp;gt;&amp;lt;/guid&amp;gt;")
  }
 
  public save(filename, content, bclean) {
   FileOutputStream fis = new FileOutputStream(new File("/tmp/${filename}"));
   def data = (bclean) ? clean1(content) : content
   fis.write(data.getBytes());
   fis.close();
  }

  boolean compare(oldContent, newContent) {
        oldContent = clean1(oldContent)
        newContent = clean1(newContent)
        return !oldContent.equals(newContent);
  }

  String diff(def oldContent, def newContent) {
        oldContent = clean2(oldContent)
        newContent = clean2(newContent)
        return xwiki.diff.getDifferencesAsHTML(oldContent, newContent, false);
  }

  public getDocument(content) {
      def newdoc = new XWikiDocument();
      newdoc.fromXML(content);
      return new Document(newdoc, context.getContext());
  }

  public getXMLFromString(content) {
      def newdoc = new XWikiDocument();
      newdoc.fromXML(content);
      return getXML2(newdoc);
  }

  public getXML(pagedoc) {
      def clonedDoc = pagedoc.document.clone();
      return getXML2(clonedDoc);
  }

  public getXML2(clonedDoc) {
        def defaultUser = "XWiki.Admin";
        def defaultDate = new Date("01/01/2010");

        // remove Tag object
        if (clonedDoc.getObject("XWiki.TagClass")) {
          clonedDoc.removeObject(clonedDoc.getObject("XWiki.TagClass"));
        }

        if (defaultUser &amp;amp;&amp;amp; defaultUser!="") {
          clonedDoc.setCreator(defaultUser);
          clonedDoc.setContentAuthor(defaultUser);
          clonedDoc.setAuthor(defaultUser);
        } else {
          clonedDoc.setCreator(clonedDoc.getAuthor());
          clonedDoc.setContentAuthor(clonedDoc.getAuthor());
        }
    
        if (defaultDate &amp;amp;&amp;amp; defaultDate!="") {
          clonedDoc.setCreationDate(defaultDate);
          clonedDoc.setContentUpdateDate(defaultDate);
          clonedDoc.setDate(defaultDate);
          clonedDoc.setVersion("1.1");
        } else {
          clonedDoc.setContentUpdateDate(clonedDoc.getDate())
          clonedDoc.setCreationDate(clonedDoc.getDate())
          clonedDoc.setVersion("1.1");
        }  
        clonedDoc.setComment("");
        clonedDoc.setMinorEdit(false);
        def c = clonedDoc.toXML(true, false, true, false, context.getContext())
        return c.trim().replaceAll("[\r]","");
    }

    Map&amp;lt;String, String&amp;gt; getZipContent(String url) throws Exception
    {
        Map&amp;lt;String, String&amp;gt; zipContent = new HashMap&amp;lt;String, String&amp;gt;();
        
        ZipInputStream zis = new ZipInputStream(new URL(url).openStream());
        byte[] buffer = new byte[2048];
        ZipEntry entry;
        while ((entry = zis.getNextEntry()) != null) {
            StringBuffer content = new StringBuffer();  
            int len = 0;
            while ((len = zis.read(buffer)) &amp;gt; 0)
            {
                content.append(new String(buffer, 0, len));
            }
            zipContent.put(entry.getName(), content.toString());
        }
        zis.close();
        
        return zipContent;
    }

}

/* *# */&lt;/content&gt;&lt;/xwikidoc&gt;
@
</versions></xwikidoc>